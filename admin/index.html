<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Administrador</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html,body{height:100%;margin:0}
      body{display:flex;align-items:center;justify-content:center;background:#111;color:#eee;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
      #wrap{display:flex;flex-direction:column;gap:14px;align-items:center;justify-content:center;
            padding:24px 28px;border:1px solid #333;border-radius:14px;background:#181818;
            box-shadow:0 4px 20px rgba(0,0,0,.25);max-width:680px}
      .btn{appearance:none;border:1px solid #444;background:#222;color:#fff;padding:10px 16px;border-radius:10px;cursor:pointer}
      .btn:hover{background:#2a2a2a}
      .ok{color:#7CFC7C}
      .err{color:#ff6b6b;white-space:pre-wrap}
      small{opacity:.8}
    </style>
    <!-- Netlify Identity (login sin servidor propio) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <!-- Decap CMS -->
    <script src="https://cdn.jsdelivr.net/npm/decap-cms@3.0.9/dist/decap-cms.js"></script>
  </head>
  <body>
    <div id="wrap">
      <div id="status">Cargando…</div>
      <button id="openLogin" class="btn" style="display:none">Abrir login</button>
      <small>Si no aparece el modal, probá abrir <b>/admin/?auth=1</b> o tocá “Abrir login”.</small>
    </div>

    <script>
      const statusEl = document.getElementById('status');
      const openBtn = document.getElementById('openLogin');
      function setStatus(msg, cls){ statusEl.textContent = msg; statusEl.className = cls || ''; }

      // Abre el modal y evita que se cierre solo
      function forceOpenLogin(tab='login'){
        try{
          if (!window.netlifyIdentity) return;
          // quita listeners previos
          window.netlifyIdentity.off && window.netlifyIdentity.off('init');
          window.netlifyIdentity.off && window.netlifyIdentity.off('login');
          window.netlifyIdentity.off && window.netlifyIdentity.off('logout');

          window.netlifyIdentity.open(tab);               // abre modal
          window.netlifyIdentity.on('login', () => {      // al loguear, recarga y entra
            location.reload();
          });
          window.netlifyIdentity.on('logout', () => {     // si cierra sesión, reabrimos login
            window.netlifyIdentity.open('login');
          });
        }catch(e){ console.error(e); setStatus('No se pudo abrir el login: '+e.message,'err'); }
      }

      // Botón manual
      openBtn.addEventListener('click', ()=>forceOpenLogin('login'));

      // Inicializa Identity y CMS
      (function init(){
        // 1) Identity listo
        if (window.netlifyIdentity){
          window.netlifyIdentity.on('init', (user) => {
            if (user) {
              setStatus('Usuario autenticado ✓', 'ok');
              try { CMS.init(); setStatus('Abriendo panel…','ok'); } 
              catch(e){ setStatus('Error iniciando CMS: '+e.message,'err'); }
            } else {
              setStatus('Necesitás iniciar sesión para entrar al panel.','');
              openBtn.style.display = 'inline-block';

              // Si viene con ?auth=1 o ?signup=1, abrir el modal y mantenerlo visible
              const qs = new URLSearchParams(location.search);
              if (qs.get('auth') === '1') forceOpenLogin('login');
              if (qs.get('signup') === '1') forceOpenLogin('signup');
            }
          });
          // Dispara init (necesario en algunos navegadores)
          window.netlifyIdentity.init();
        } else {
          setStatus('No cargó Netlify Identity','err');
        }
      })();
    </script>
  </body>
</html>
