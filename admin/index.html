<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Administrador</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html,body{height:100%;margin:0}
      body{display:flex;align-items:center;justify-content:center;background:#111;color:#eee;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
      #status{padding:16px 20px;border:1px solid #333;border-radius:12px;background:#181818;box-shadow:0 4px 20px rgba(0,0,0,.25)}
      .ok{color:#7CFC7C}
      .err{color:#ff6b6b; white-space:pre-wrap}
    </style>
    <!-- Netlify Identity (login sin servidor propio) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <div id="status">Cargando panel…</div>

    <script>
      function setStatus(msg, cls){
        var el = document.getElementById('status');
        el.textContent = msg;
        el.className = cls || '';
      }

      // Cargar script con promesa
      function loadScript(src){
        return new Promise((res, rej)=>{
          const s = document.createElement('script');
          s.src = src;
          s.onload = ()=>res(src);
          s.onerror = ()=>rej(new Error('No se pudo cargar: ' + src));
          document.head.appendChild(s);
        });
      }

      // Esperar a que window.CMS exista
      function waitForCMS(timeoutMs=8000){
        return new Promise((res, rej)=>{
          const start = Date.now();
          (function check(){
            if (window.CMS) return res(window.CMS);
            if (Date.now()-start > timeoutMs) return rej(new Error('Timeout esperando CMS'));
            requestAnimationFrame(check);
          })();
        });
      }

      // Init
      (async function init(){
        try {
          // Verificamos que el config exista
          const cfg = await fetch('./config.yml', { cache: 'no-store' });
          if (!cfg.ok) throw new Error('No se pudo cargar /admin/config.yml (' + cfg.status + ')');
          setStatus('Config cargado ✓', 'ok');

          // Intento 1: jsDelivr (fijo a una versión estable)
          try {
            await loadScript('https://cdn.jsdelivr.net/npm/decap-cms@3.0.9/dist/decap-cms.js');
          } catch (e1) {
            // Intento 2 (fallback): unpkg
            await loadScript('https://unpkg.com/decap-cms@3.0.9/dist/decap-cms.js');
          }

          // Esperar a que exponga window.CMS
          await waitForCMS();

          // Opcional: manejar Netlify Identity (auto-reload al loguear)
          if (window.netlifyIdentity) {
            window.netlifyIdentity.on('init', user => {
              if (!user) window.netlifyIdentity.on('login', () => document.location.reload());
            });
          }

          // Iniciar el CMS
          CMS.init();
          setStatus('Abriendo el panel…', 'ok');
        } catch (e) {
          setStatus('Error al iniciar el CMS:\n' + (e && e.message ? e.message : e), 'err');
          console.error(e);
        }
      })();
    </script>
  </body>
</html>
