<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Esperalopy — Publicaciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0f1115; --card:#151924; --muted:#8a8ea3; --text:#eaeaea; --brand:#8ab4ff; --divider:#262b36;
    }
    *{box-sizing:border-box}
    html,body{margin:0;min-height:100%}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:var(--brand);text-decoration:none}
    a:hover{text-decoration:underline}
    header{padding:24px 20px;border-bottom:1px solid var(--divider)}
    header .row{max-width:1000px;margin:0 auto;display:flex;gap:14px;align-items:center;justify-content:space-between}
    .btn{appearance:none;border:1px solid #2a2f3a;background:#1a1f2b;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#232836}
    main{max-width:1000px;margin:0 auto;padding:24px 20px}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid var(--divider);border-radius:14px;padding:16px}
    .card h3{margin:.2rem 0 .5rem 0;font-size:1.1rem}
    .meta{font-size:.85rem;color:var(--muted);margin-bottom:.5rem}
    .empty{opacity:.85;margin-top:30px}
    .post{background:var(--card);border:1px solid var(--divider);border-radius:14px;padding:22px}
    .post h1{margin-top:0}
    .back{display:inline-block;margin-bottom:16px}
    footer{margin:40px 0 30px 0;text-align:center;color:var(--muted);font-size:.9rem}
    .badge{font-size:.8rem;color:#7CFC7C}
    code{background:#0d0f14;padding:2px 4px;border-radius:6px;border:1px solid #1f2330}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
</head>
<body>
  <header>
    <div class="row">
      <div>
        <strong>Esperalopy</strong> · <span class="badge">CMS activo</span>
      </div>
      <div>
        <a class="btn" href="/admin/">Entrar al CMS</a>
      </div>
    </div>
  </header>

  <main id="app"></main>

  <footer>
    Publicado con Decap CMS + Netlify · <a href="https://github.com/esperalopy/esperalopy.github.io">Repo</a>
  </footer>

  <script>
    const OWNER  = 'esperalopy';
    const REPO   = 'esperalopy.github.io';
    const BRANCH = 'main';
    const POSTS_DIR = 'content/posts';

    const fmtDate = (iso) => { try { return new Date(iso).toLocaleDateString('es-PY',{year:'numeric',month:'short',day:'numeric'});} catch {return iso;} };
    const parseFrontMatter = (txt) => {
      const m = txt.match(/^---\s*([\s\S]*?)\s*---\s*([\s\S]*)$/);
      if(!m) return { data:{}, body:txt };
      const yaml = m[1], body = m[2], data = {};
      yaml.split(/\r?\n/).forEach(line=>{
        const mm = line.match(/^\s*([A-Za-z0-9_-]+)\s*:\s*(.*)\s*$/);
        if(mm){ data[mm[1]] = mm[2].trim().replace(/^"(.*)"$/,'$1'); }
      });
      return { data, body };
    };
    const el = (html)=>{ const d=document.createElement('div'); d.innerHTML=html; return d.firstElementChild; };

    const params = new URLSearchParams(location.search);
    const postPath = params.get('post');

    async function listPosts(){
      const app = document.getElementById('app');
      app.innerHTML = '<p>Cargando publicaciones…</p>';
      const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${POSTS_DIR}?ref=${BRANCH}`;
      const res = await fetch(url);
      if(!res.ok){ app.innerHTML = `<p class="empty">No se pudo listar posts (${res.status}).</p>`; return; }
      const files = (await res.json()).filter(f=>f.type==='file' && /\.md$/.test(f.name));
      if(files.length===0){ app.innerHTML = '<p class="empty">No hay publicaciones. Creá una en <b>/admin</b>.</p>'; return; }

      const items = [];
      for(const f of files){
        const raw = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${POSTS_DIR}/${encodeURIComponent(f.name)}`;
        const txt = await (await fetch(raw)).text();
        const { data } = parseFrontMatter(txt);
        items.push({
          file: f.name,
          title: data.title || f.name.replace(/\.md$/,''),
          date:  data.date || '',
          description: data.description || ''
        });
      }
      items.sort((a,b)=> (new Date(b.date) - new Date(a.date)));

      const wrap = el('<div class="cards"></div>');
      items.forEach(it=>{
        const href = `/?post=${encodeURIComponent(`${POSTS_DIR}/${it.file}`)}`;
        wrap.appendChild(el(`
          <article class="card">
            <div class="meta">${it.date ? fmtDate(it.date) : ''}</div>
            <h3><a href="${href}">${it.title}</a></h3>
            <p>${it.description || ''}</p>
            <p><a href="${href}">Leer más →</a></p>
          </article>
        `));
      });
      app.innerHTML = '';
      app.appendChild(wrap);
    }

    async function showPost(repoPath){
      const app = document.getElementById('app');
      app.innerHTML = '<p>Cargando publicación…</p>';
      const raw = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${repoPath}`;
      const txt = await (await fetch(raw)).text();
      const { data, body } = parseFrontMatter(txt);
      const html = marked.parse(body);
      app.innerHTML = '';
      app.appendChild(el(`
        <article class="post">
          <a class="back" href="/">← Volver</a>
          <h1>${data.title || 'Publicación'}</h1>
          <div class="meta">${data.date ? fmtDate(data.date) : ''}</div>
          <div>${html}</div>
        </article>
      `));
    }

    if(postPath){ showPost(postPath); } else { listPosts(); }
  </script>
</body>
</html>
